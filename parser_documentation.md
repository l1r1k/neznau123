# Документация модуля парсера и системы кэширования

## Обзор

Модуль парсера в приложении MyMPT отвечает за извлечение информации о расписании с официального сайта Московского Приборостроительного Техникума и преобразование её в структурированные данные для использования в мобильном приложении. Система кэширования обеспечивает эффективное хранение и доступ к данным без постоянных сетевых запросов.

## Архитектура парсера

### Основные компоненты

#### 1. ScheduleHtmlParser (`lib/data/parsers/schedule_html_parser.dart`)
Основной класс парсера, который преобразует HTML-страницу с расписанием в структурированные данные. Основные функции:
- Извлечение информации о предметах, преподавателях и аудиториях
- Парсинг временных интервалов и номеров пар
- Обработка специальных случаев (числитель/знаменатель)
- Преобразование HTML-элементов в объекты [Lesson](file:///c%3A/WORK/Projects/MyMPT/MyMPT/lib/data/models/lesson.dart#L5-L45)

#### 2. Источники данных
- **ScheduleRemoteDataSource** (`lib/data/datasources/schedule_remote_data_source.dart`): Загружает свежие данные с сайта техникума
- **ScheduleCacheDataSource** (`lib/data/datasources/schedule_cache_data_source.dart`): Управляет локальным кэшем расписания

#### 3. Сервисы
- **ScheduleParserService** (`lib/data/services/schedule_parser_service.dart`): Координирует процесс парсинга
- **UnifiedScheduleRepository** (`lib/data/repositories/unified_schedule_repository.dart`): Единая точка доступа к данным расписания

## Система кэширования

### Механизм кэширования

Система кэширования в MyMPT использует двухуровневый подход:

1. **Кэш на уровне HTTP-запросов** (в [ScheduleRemoteDataSource](file:///c%3A/WORK/Projects/MyMPT/MyMPT/lib/data/datasources/schedule_remote_data_source.dart#L9-L100)):
   - Время жизни: 24 часа
   - Хранит сырую HTML-страницу
   - Уменьшает количество сетевых запросов

2. **Кэш на уровне приложения** (в [ScheduleCacheDataSource](file:///c%3A/WORK/Projects/MyMPT/MyMPT/lib/data/datasources/schedule_cache_data_source.dart#L38-L231)):
   - Использует SharedPreferences для постоянного хранения
   - Хранит структурированные данные расписания
   - Сохраняет расписание на неделю, сегодня и завтра

### Структура кэша

Кэш представлен моделью [ScheduleCache](file:///c%3A/WORK/Projects/MyMPT/MyMPT/lib/data/datasources/schedule_cache_data_source.dart#L10-L36), которая содержит:
- `weeklySchedule`: Расписание на неделю (Map<String, List<Schedule>>)
- `todaySchedule`: Расписание на сегодня (List<Schedule>)
- `tomorrowSchedule`: Расписание на завтра (List<Schedule>)
- `lastUpdate`: Время последнего обновления (DateTime)

### Алгоритм работы с кэшем

1. При запуске приложение пытается восстановить данные из кэша
2. Если кэш отсутствует или устарел (более 24 часов), запускается процесс обновления
3. При обновлении данные загружаются с сайта, парсятся и сохраняются в кэш
4. При ошибке загрузки или парсинга кэш очищается

## Модели данных

### Lesson (`lib/data/models/lesson.dart`)
Представляет отдельный урок в расписании:
- `number`: Номер пары
- `subject`: Название предмета
- `teacher`: Преподаватель
- `startTime`: Время начала
- `endTime`: Время окончания
- `building`: Корпус
- `lessonType`: Тип пары (числитель/знаменатель/null)

### Schedule (`lib/domain/entities/schedule.dart`)
Доменная сущность, используемая в UI слое:
- `id`: Уникальный идентификатор
- Остальные поля аналогичны [Lesson](file:///c%3A/WORK/Projects/MyMPT/MyMPT/lib/data/models/lesson.dart#L5-L45)

## Процесс парсинга

### Этапы парсинга

1. **Загрузка HTML-страницы**
   - Проверка кэша в [ScheduleRemoteDataSource](file:///c%3A/WORK/Projects/MyMPT/MyMPT/lib/data/datasources/schedule_remote_data_source.dart#L9-L100)
   - При необходимости загрузка с сайта mpt.ru

2. **Поиск вкладки группы**
   - Поиск вкладки, соответствующей выбранной группе
   - Использование строгих CSS-селекторов для точного совпадения

3. **Извлечение таблиц расписания**
   - Поиск таблиц с классом "table"
   - Извлечение заголовков с днями недели

4. **Парсинг строк таблиц**
   - Извлечение номера пары и времени
   - Обработка обычных пар и пар с числителем/знаменателем
   - Извлечение информации о предметах и преподавателях

5. **Преобразование в доменные сущности**
   - Преобразование [Lesson](file:///c%3A/WORK/Projects/MyMPT/MyMPT/lib/data/models/lesson.dart#L5-L45) в [Schedule](file:///c%3A/WORK/Projects/MyMPT/MyMPT/lib/domain/entities/schedule.dart#L5-L50)
   - Присвоение уникальных идентификаторов

## Интеграция с другими компонентами

### Использование в репозиториях
[UnifiedScheduleRepository](file:///c%3A/WORK/Projects/MyMPT/MyMPT/lib/data/repositories/unified_schedule_repository.dart#L8-L217) выступает в роли фасада для доступа к данным:
- Объединяет удаленный и локальный источники данных
- Управляет кэшированием на уровне приложения
- Предоставляет унифицированный интерфейс для получения расписания

### Использование в UI
UI-компоненты используют данные через:
- `getWeeklySchedule()`: Получение недельного расписания
- `getTodaySchedule()`: Получение сегодняшнего расписания
- `getTomorrowSchedule()`: Получение завтрашнего расписания

## Обработка ошибок

Система включает надежную обработку ошибок на всех уровнях:

1. **Сетевые ошибки**
   - Таймауты (15 секунд на запрос)
   - Недоступность сервера
   - Неверные HTTP-статусы

2. **Ошибки парсинга**
   - Некорректная HTML-разметка
   - Отсутствующие элементы
   - Неверный формат данных

3. **Ошибки кэширования**
   - Повреждение данных в SharedPreferences
   - Проблемы с сериализацией/десериализацией

При возникновении ошибок система:
- Очищает кэш
- Возвращает пустые данные вместо выброса исключений
- Логирует ошибки для отладки

## Производительность

### Оптимизации
1. **Кэширование на нескольких уровнях**
2. **Ленивая загрузка данных**
3. **Минимизация сетевых запросов**
4. **Эффективная сериализация данных**

### Время жизни кэша
- HTML-страница: 24 часа
- Структурированные данные: 24 часа
- Принудительное обновление: По запросу пользователя

## Обновление данных

### Автоматическое обновление
- Проверка давности данных при каждом запросе
- Автоматическое обновление при устаревании (более 24 часов)

### Ручное обновление
- Через экран настроек
- При смене группы
- По запросу пользователя

## Безопасность

### Защита от некорректных данных
- Валидация входных данных
- Обработка граничных случаев
- Устойчивость к изменениям структуры сайта

### Конфиденциальность
- Локальное хранение данных пользователя
- Отсутствие передачи персональных данных на сторонние серверы